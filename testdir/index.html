<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>割り勘計算アプリ</title>
  <style>
    body {
      font-family: "Arial", sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 10px;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 15px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .section {
      margin-bottom: 20px;
    }
    .history-item {
      background: #f1f1f1;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
      font-size: 15px;
    }
    .results {
      background: #eef;
      padding: 10px;
      border-radius: 6px;
    }
    @media (max-width: 480px) {
      h1 { font-size: 20px; }
      input, select, button { font-size: 14px; }
    }
  </style>
</head>
<body>
  <h1>割り勘計算アプリ</h1>
  <div class="container">
    <div class="section">
      <h3>対象者の追加</h3>
      <input type="text" id="nameInput" placeholder="名前を入力">
      <button onclick="addUser()">追加</button>
      <button onclick="resetApp()" style="background:#e74c3c;">初期化</button>
      <div id="usersList"></div>
    </div>

    <div class="section">
      <h3>支払い追加</h3>
      <select id="payer"></select>
      <input type="number" id="amount" placeholder="金額 (円)">
      <select id="beneficiaries"></select>
      <button onclick="addPayment()">追加</button>
      <div id="history"></div>
    </div>

    <div class="section">
      <h3>精算結果</h3>
      <button onclick="calculate()">計算</button>
      <div id="results" class="results"></div>
    </div>
  </div>

  <script>
    let users = JSON.parse(localStorage.getItem("users")) || [];
    let payments = JSON.parse(localStorage.getItem("payments")) || [];

    function saveData() {
      localStorage.setItem("users", JSON.stringify(users));
      localStorage.setItem("payments", JSON.stringify(payments));
    }

    function renderUsers() {
      const usersList = document.getElementById("usersList");
      const payerSelect = document.getElementById("payer");
      const beneficiariesSelect = document.getElementById("beneficiaries");

      usersList.innerHTML = "";
      payerSelect.innerHTML = "";
      beneficiariesSelect.innerHTML = "";

      users.forEach((u, i) => {
        usersList.innerHTML += `<div>${u} <button onclick="removeUser(${i})">削除</button></div>`;
        payerSelect.innerHTML += `<option value="${u}">${u}</option>`;
        beneficiariesSelect.innerHTML += `<option value="${u}">${u}</option>`;
      });
      if (users.length > 1) {
        beneficiariesSelect.innerHTML += `<option value="ALL">全員</option>`;
      }
    }

    function renderHistory() {
      const historyDiv = document.getElementById("history");
      historyDiv.innerHTML = "";
      payments.forEach(p => {
        historyDiv.innerHTML += `<div class="history-item">${p.payer} が ${p.amount}円 を ${p.beneficiaries.join(", ")} のために支払った</div>`;
      });
    }

    function addUser() {
      const name = document.getElementById("nameInput").value.trim();
      if (name && !users.includes(name)) {
        users.push(name);
        saveData();
        renderUsers();
      }
      document.getElementById("nameInput").value = "";
    }

    function removeUser(index) {
      users.splice(index, 1);
      payments = payments.filter(p => p.payer !== users[index] && !p.beneficiaries.includes(users[index]));
      saveData();
      renderUsers();
      renderHistory();
    }

    function addPayment() {
      const payer = document.getElementById("payer").value;
      const amount = parseInt(document.getElementById("amount").value);
      const beneficiary = document.getElementById("beneficiaries").value;

      if (!payer || !amount || !beneficiary) return;

      let beneficiaries = [];
      if (beneficiary === "ALL") {
        beneficiaries = [...users];
      } else {
        beneficiaries = [beneficiary];
      }

      payments.push({ payer, amount, beneficiaries });
      saveData();
      renderHistory();

      document.getElementById("amount").value = "";
    }

    function calculate() {
      let balances = {};
      users.forEach(u => balances[u] = 0);

      payments.forEach(p => {
        const share = p.amount / p.beneficiaries.length;
        p.beneficiaries.forEach(b => {
          if (b !== p.payer) {
            balances[b] -= share;
            balances[p.payer] += share;
          }
        });
      });

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";
      users.forEach(u => {
        if (balances[u] < 0) {
          const creditors = users.filter(x => balances[x] > 0);
          creditors.forEach(c => {
            let amount = Math.min(-balances[u], balances[c]);
            if (amount > 0) {
              resultsDiv.innerHTML += `<div>${u} → ${c}: ${amount}円</div>`;
              balances[u] += amount;
              balances[c] -= amount;
            }
          });
        }
      });
    }

    function resetApp() {
      if (confirm("全データを削除しますか？")) {
        users = [];
        payments = [];
        saveData();
        renderUsers();
        renderHistory();
        document.getElementById("results").innerHTML = "";
      }
    }

    renderUsers();
    renderHistory();
  </script>
</body>
</html>