<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>割り勘アプリ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button { margin: 5px; }
    ul { list-style: none; padding: 0; }
    li { margin: 3px 0; }
  </style>
</head>
<body>
  <h1>割り勘アプリ</h1>

  <h2>参加者追加</h2>
  <input id="personName" placeholder="名前">
  <button onclick="addPerson()">追加</button>
  <ul id="persons"></ul>

  <h2>支払い入力</h2>
  <select id="payer"></select>
  <input id="amount" type="number" placeholder="金額">
  <select id="forWhom" multiple></select>
  <button onclick="addPayment()">追加</button>
  <ul id="payments"></ul>

  <h2>精算結果</h2>
  <button onclick="calculate()">計算する</button>
  <ul id="result"></ul>

  <script>
    let persons = JSON.parse(localStorage.getItem('persons') || '[]');
    let payments = JSON.parse(localStorage.getItem('payments') || '[]');

    function saveData() {
      localStorage.setItem('persons', JSON.stringify(persons));
      localStorage.setItem('payments', JSON.stringify(payments));
    }

    function renderPersons() {
      const ul = document.getElementById('persons');
      ul.innerHTML = '';
      persons.forEach(p => {
        const li = document.createElement('li');
        li.textContent = p;
        ul.appendChild(li);
      });

      const payer = document.getElementById('payer');
      const forWhom = document.getElementById('forWhom');
      payer.innerHTML = '';
      forWhom.innerHTML = '';

      persons.forEach(p => {
        const opt1 = document.createElement('option');
        opt1.value = opt1.textContent = p;
        payer.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = opt2.textContent = p;
        forWhom.appendChild(opt2);
      });

      const allOpt = document.createElement('option');
      allOpt.value = 'ALL';
      allOpt.textContent = '全員分';
      forWhom.appendChild(allOpt);
    }

    function renderPayments() {
      const ul = document.getElementById('payments');
      ul.innerHTML = '';
      payments.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.payer} が ${p.forWhom.join(', ')} のために ${p.amount}円 支払い`;
        ul.appendChild(li);
      });
    }

    function addPerson() {
      const name = document.getElementById('personName').value.trim();
      if (!name || persons.includes(name)) return;
      persons.push(name);
      saveData();
      renderPersons();
      document.getElementById('personName').value = '';
    }

    function addPayment() {
      const payer = document.getElementById('payer').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const forWhomOptions = document.getElementById('forWhom').selectedOptions;
      let forWhom = Array.from(forWhomOptions).map(o => o.value);

      // 「全員分」を選んだときだけ persons 全員に展開
      if (forWhom.includes('ALL')) {
        forWhom = [...persons];
      }

      if (!payer || !amount || forWhom.length === 0) return;

      payments.push({ payer, amount, forWhom });
      saveData();
      renderPayments();
      document.getElementById('amount').value = '';
    }

    function calculate() {
      const balances = {};
      persons.forEach(p => balances[p] = 0);

      payments.forEach(p => {
        const share = p.amount / p.forWhom.length;
        p.forWhom.forEach(person => {
          balances[person] -= share;
        });
        balances[p.payer] += p.amount;
      });

      const result = [];
      const owes = Object.entries(balances)
        .filter(([_, v]) => v < 0)
        .map(([k, v]) => ({ name: k, amt: -v }));
      const receives = Object.entries(balances)
        .filter(([_, v]) => v > 0)
        .map(([k, v]) => ({ name: k, amt: v }));

      let i = 0, j = 0;
      while (i < owes.length && j < receives.length) {
        const pay = Math.min(owes[i].amt, receives[j].amt);
        result.push(`${owes[i].name} → ${receives[j].name}: ${pay.toFixed(0)}円`);
        owes[i].amt -= pay;
        receives[j].amt -= pay;
        if (owes[i].amt === 0) i++;
        if (receives[j].amt === 0) j++;
      }

      const ul = document.getElementById('result');
      ul.innerHTML = '';
      result.forEach(r => {
        const li = document.createElement('li');
        li.textContent = r;
        ul.appendChild(li);
      });
    }

    renderPersons();
    renderPayments();
  </script>
</body>
</html>