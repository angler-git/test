<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>💰割り勘計算アプリ💰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: "Segoe UI", sans-serif; background: #f5f5f5; padding: 10px; margin: 0;}
  h2, h3 { color: #333; text-align: center; }
  .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
  input, select, button { margin: 5px 0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box;}
  button { background: #4CAF50; color: white; border: none; cursor: pointer; transition: 0.3s; font-size: 16px; }
  button:hover { background: #45a049; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; overflow-x: auto; display: block; font-size: 12px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; min-width: 60px; word-break: break-word; }
  th { background-color: #f2f2f2; font-size: 14px; }
  ul { padding-left: 20px; text-align: center; }
  @media (max-width: 480px) {
    h2 { font-size: 20px; }
    h3 { font-size: 16px; }
    button { font-size: 14px; }
    table { font-size: 11px; }
  }
</style>
</head>
<body>

<h2>💰割り勘計算アプリ💰</h2>

<!-- 初期化ボタン -->
<div class="card">
  <button onclick="initialize()">初期化</button>
</div>

<!-- 参加者追加 -->
<div class="card">
  <h3>参加者追加</h3>
  <input type="text" id="personName" placeholder="名前を入力">
  <button onclick="addPerson()">追加</button>
  <h3>参加者リスト</h3>
  <table id="personTable">
    <thead>
      <tr><th>名前</th><th>操作</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- 支払い追加 -->
<div class="card">
  <h3>支払い追加</h3>
  <label>誰が支払った: </label>
  <select id="payer"></select><br>
  <label>金額: </label>
  <input type="number" id="amount" placeholder="金額"><br>
  <label>誰の分: </label>
  <select id="forWhom" multiple></select><br>
  <label>何代: </label>
  <input type="text" id="note" placeholder="例: ランチ代"><br>
  <button onclick="addPayment()">追加</button>
</div>

<!-- 支払い履歴 -->
<div class="card">
  <h3>支払い履歴</h3>
  <table id="paymentTable">
    <thead>
      <tr><th>選択</th><th>支払者</th><th>金額</th><th>対象者</th><th>何代</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="deleteSelectedPayments()">選択削除</button>
</div>

<!-- 計算結果 -->
<div class="card">
  <button onclick="calculate()">精算計算</button>
  <h3>精算結果</h3>
  <ul id="result"></ul>
</div>

<script>
// ===== IndexedDB ユーティリティ =====
let db;
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("WarikanDB", 1);
    request.onerror = () => reject("IndexedDBを開けません");
    request.onsuccess = () => { db = request.result; resolve(db); };
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("data")) {
        db.createObjectStore("data");
      }
    };
  });
}

function saveToDB(key, value) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("data", "readwrite");
    tx.objectStore("data").put(value, key);
    tx.oncomplete = resolve;
    tx.onerror = reject;
  });
}

function loadFromDB(key) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("data", "readonly");
    const req = tx.objectStore("data").get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = reject;
  });
}

// ===== データ管理 =====
let persons = [];
let payments = [];

async function saveData() {
  await saveToDB("persons", persons);
  await saveToDB("payments", payments);
}

async function loadData() {
  persons = await loadFromDB("persons") || [];
  payments = await loadFromDB("payments") || [];
  updatePersonSelect();
  renderPersonTable();
  renderPayments();
}

// ===== UI更新 =====
function updatePersonSelect() {
  const payerSelect = document.getElementById('payer');
  const forWhomSelect = document.getElementById('forWhom');
  payerSelect.innerHTML = '';
  forWhomSelect.innerHTML = '';
  persons.forEach(p => {
    payerSelect.add(new Option(p, p));
    forWhomSelect.add(new Option(p, p));
  });
  if (persons.length > 0) {
    const allOption = new Option("全員分", "ALL");
    forWhomSelect.insertBefore(allOption, forWhomSelect.firstChild);
  }
}

function renderPersonTable() {
  const tbody = document.querySelector('#personTable tbody');
  tbody.innerHTML = '';
  persons.forEach((p, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p}</td>
      <td><button onclick="deletePerson(${idx})">削除</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderPayments() {
  const tbody = document.querySelector('#paymentTable tbody');
  tbody.innerHTML = '';
  payments.forEach((p, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" data-index="${idx}"></td>
      <td>${p.payer}</td>
      <td>${p.amount}</td>
      <td>${p.forWhom.join('<br>')}</td>
      <td>${p.note || ''}</td>`;
    tbody.appendChild(tr);
  });
}

// ===== 操作 =====
function initialize() {
  if(confirm("全てのデータを初期化しますか？")){
    persons = [];
    payments = [];
    saveData();
    updatePersonSelect();
    renderPersonTable();
    renderPayments();
    document.getElementById('result').innerHTML = '';
  }
}

function addPerson() {
  const name = document.getElementById('personName').value.trim();
  if(name && !persons.includes(name)){
    persons.push(name);
    saveData();
    updatePersonSelect();
    renderPersonTable();
    document.getElementById('personName').value = '';
  }
}

function deletePerson(idx) {
  const name = persons[idx];
  persons.splice(idx, 1);
  payments = payments.map(pay => ({
    ...pay,
    forWhom: pay.forWhom.filter(f => f !== name)
  })).filter(pay => pay.forWhom.length > 0);
  saveData();
  updatePersonSelect();
  renderPersonTable();
  renderPayments();
}

function addPayment() {
  const payer = document.getElementById('payer').value;
  const amount = parseFloat(document.getElementById('amount').value);
  const note = document.getElementById('note').value.trim();
  let forWhom = Array.from(document.getElementById('forWhom').selectedOptions).map(o => o.value);
  if (forWhom.includes('ALL')) forWhom = [...persons];
  if(!payer || !amount || forWhom.length === 0) return;
  payments.push({payer, amount, forWhom, note});
  saveData();
  renderPayments();
  document.getElementById('amount').value = '';
  document.getElementById('note').value = '';
}

function deleteSelectedPayments() {
  const checks = document.querySelectorAll('#paymentTable tbody input[type=checkbox]:checked');
  const indexes = Array.from(checks).map(c => parseInt(c.dataset.index));
  payments = payments.filter((_, i) => !indexes.includes(i));
  saveData();
  renderPayments();
}

function calculate() {
  const balances = {};
  persons.forEach(p => balances[p] = 0);
  payments.forEach(p => {
    const share = p.amount / p.forWhom.length;
    p.forWhom.forEach(person => balances[person] -= share);
    balances[p.payer] += p.amount;
  });
  const result = [];
  const owes = Object.entries(balances).filter(([k,v]) => v<0).map(([k,v]) => ({name:k, amt:-v}));
  const receives = Object.entries(balances).filter(([k,v]) => v>0).map(([k,v]) => ({name:k, amt:v}));
  let i = 0, j = 0;
  while(i<owes.length && j<receives.length){
    const pay = Math.min(owes[i].amt, receives[j].amt);
    result.push(`${owes[i].name} → ${receives[j].name}: ${pay.toFixed(0)}円`);
    owes[i].amt -= pay;
    receives