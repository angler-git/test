<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>割り勘計算アプリ</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  input, select, button { margin: 5px; }
  table { border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 5px 10px; }
</style>
</head>
<body>

<h2>割り勘計算アプリ</h2>

<div>
  <button onclick="initialize()">初期化</button>
</div>

<div>
  <label>参加者の名前: </label>
  <input type="text" id="personName">
  <button onclick="addPerson()">追加</button>
  <button onclick="clearPersons()">削除</button>
</div>

<div>
  <h3>参加者</h3>
  <ul id="personList"></ul>
</div>

<div>
  <h3>支払い追加</h3>
  <label>誰が支払った: </label>
  <select id="payer"></select>
  <label>金額: </label>
  <input type="number" id="amount">
  <label>誰の分: </label>
  <select id="forWhom" multiple></select>
  <button onclick="addPayment()">追加</button>
</div>

<div>
  <h3>支払い履歴</h3>
  <table id="paymentTable">
    <thead>
      <tr><th>支払者</th><th>金額</th><th>対象者</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div>
  <button onclick="calculate()">計算</button>
  <h3>精算結果</h3>
  <ul id="result"></ul>
</div>

<script>
let persons = JSON.parse(localStorage.getItem('persons') || '[]');
let payments = JSON.parse(localStorage.getItem('payments') || '[]');

function updatePersonSelect() {
  const payerSelect = document.getElementById('payer');
  const forWhomSelect = document.getElementById('forWhom');
  payerSelect.innerHTML = '';
  forWhomSelect.innerHTML = '';
  persons.forEach(p => {
    const option1 = document.createElement('option');
    option1.value = p;
    option1.textContent = p;
    payerSelect.appendChild(option1);
    const option2 = document.createElement('option');
    option2.value = p;
    option2.textContent = p;
    forWhomSelect.appendChild(option2);
  });
}

function updatePersonList() {
  const list = document.getElementById('personList');
  list.innerHTML = '';
  persons.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p;
    list.appendChild(li);
  });
}

function renderPayments() {
  const tbody = document.querySelector('#paymentTable tbody');
  tbody.innerHTML = '';
  payments.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.payer}</td><td>${p.amount}</td><td>${p.forWhom.join(', ')}</td>`;
    tbody.appendChild(tr);
  });
}

function saveData() {
  localStorage.setItem('persons', JSON.stringify(persons));
  localStorage.setItem('payments', JSON.stringify(payments));
}

function initialize() {
  if(confirm("全てのデータを初期化しますか？")){
    localStorage.removeItem('persons');
    localStorage.removeItem('payments');
    persons = [];
    payments = [];
    updatePersonSelect();
    updatePersonList();
    renderPayments();
    document.getElementById('result').innerHTML = '';
  }
}

function addPerson() {
  const name = document.getElementById('personName').value.trim();
  if(name && !persons.includes(name)){
    persons.push(name);
    saveData();
    updatePersonSelect();
    updatePersonList();
    document.getElementById('personName').value = '';
  }
}

function clearPersons() {
  if(confirm("参加者と支払い履歴を削除しますか？")){
    persons = [];
    payments = [];
    saveData();
    updatePersonSelect();
    updatePersonList();
    renderPayments();
    document.getElementById('result').innerHTML = '';
  }
}

function addPayment() {
  const payer = document.getElementById('payer').value;
  const amount = parseFloat(document.getElementById('amount').value);
  const forWhomOptions = document.getElementById('forWhom').selectedOptions;
  const forWhom = Array.from(forWhomOptions).map(o => o.value);
  if(!payer || !amount || forWhom.length === 0) return;

  payments.push({payer, amount, forWhom});
  saveData();
  renderPayments();
  document.getElementById('amount').value = '';
}

function calculate() {
  const balances = {};
  persons.forEach(p => balances[p] = 0);

  payments.forEach(p => {
    const share = p.amount / p.forWhom.length;
    p.forWhom.forEach(person => {
      balances[person] -= share;
    });
    balances[p.payer] += p.amount;
  });

  const result = [];
  const owes = Object.entries(balances).filter(([k,v]) => v<0).map(([k,v]) => ({name:k, amt:-v}));
  const receives = Object.entries(balances).filter(([k,v]) => v>0).map(([k,v]) => ({name:k, amt:v}));

  let i = 0, j = 0;
  while(i<owes.length && j<receives.length){
    const pay = Math.min(owes[i].amt, receives[j].amt);
    result.push(`${owes[i].name} → ${receives[j].name}: ${pay.toFixed(0)}円`);
    owes[i].amt -= pay;
    receives[j].amt -= pay;
    if(owes[i].amt === 0) i++;
    if(receives[j].amt === 0) j++;
  }

  const ul = document.getElementById('result');
  ul.innerHTML = '';
  result.forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    ul.appendChild(li);
  });
}

// ページ読み込み時にデータを反映
updatePersonSelect();
updatePersonList();
renderPayments();

</script>
</body>
</html>