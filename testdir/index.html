<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å‰²ã‚Šå‹˜è¨ˆç®—ã‚¢ãƒ—ãƒª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: "Segoe UI", sans-serif; background: #f5f5f5; padding: 10px; margin: 0;}
  h1, h2, h3 { color: #333; text-align: center; margin: 10px 0; }
  h1 { font-size: 28px; }
  .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
  input, select, button { margin: 5px 0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box;}
  button { background: #4CAF50; color: white; border: none; cursor: pointer; transition: 0.3s; font-size: 16px; }
  button:hover { background: #45a049; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; overflow-x: auto; display: block; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; min-width: 80px; }
  th { background-color: #f2f2f2; }
  ul { padding-left: 20px; }
  @media (max-width: 480px) {
    h1 { font-size: 22px; }
    h2 { font-size: 20px; }
    h3 { font-size: 16px; }
    button { font-size: 14px; }
  }
</style>
</head>
<body>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<h1>ğŸ’°å‰²ã‚Šå‹˜è¨ˆç®—ã‚¢ãƒ—ãƒªğŸ’°</h1>

<!-- åˆæœŸåŒ–ãƒœã‚¿ãƒ³ -->
<div class="card">
  <button onclick="initialize()">åˆæœŸåŒ–</button>
</div>

<!-- å‚åŠ è€…è¿½åŠ  -->
<div class="card">
  <h3>å‚åŠ è€…è¿½åŠ </h3>
  <input type="text" id="personName" placeholder="åå‰ã‚’å…¥åŠ›">
  <button onclick="addPerson()">è¿½åŠ </button>
  <button onclick="deleteSelectedPersons()">é¸æŠå‰Šé™¤</button>
  <h4>å‚åŠ è€…ãƒªã‚¹ãƒˆ</h4>
  <ul id="personList"></ul>
</div>

<!-- æ”¯æ‰•ã„è¿½åŠ  -->
<div class="card">
  <h3>æ”¯æ‰•ã„è¿½åŠ </h3>
  <label>èª°ãŒæ”¯æ‰•ã£ãŸ: </label>
  <select id="payer"></select><br>
  <label>é‡‘é¡: </label>
  <input type="number" id="amount" placeholder="é‡‘é¡"><br>
  <label>èª°ã®åˆ†: </label>
  <select id="forWhom" multiple></select><br>
  <button onclick="addPayment()">è¿½åŠ </button>
</div>

<!-- æ”¯æ‰•ã„å±¥æ­´ -->
<div class="card">
  <h3>æ”¯æ‰•ã„å±¥æ­´</h3>
  <button onclick="deleteSelectedPayments()">é¸æŠå‰Šé™¤</button>
  <table id="paymentTable">
    <thead>
      <tr>
        <th>é¸æŠ</th>
        <th>æ”¯æ‰•è€…</th>
        <th>é‡‘é¡</th>
        <th>å¯¾è±¡è€…</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- è¨ˆç®—çµæœ -->
<div class="card">
  <button onclick="calculate()">ç²¾ç®—è¨ˆç®—</button>
  <h3>ç²¾ç®—çµæœ</h3>
  <ul id="result"></ul>
</div>

<script>
let persons = JSON.parse(localStorage.getItem('persons') || '[]');
let payments = JSON.parse(localStorage.getItem('payments') || '[]');

// å‚åŠ è€…ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
function updatePersonSelect() {
  const payerSelect = document.getElementById('payer');
  const forWhomSelect = document.getElementById('forWhom');
  payerSelect.innerHTML = '';
  forWhomSelect.innerHTML = '';
  persons.forEach(p => {
    const option1 = document.createElement('option');
    option1.value = p; option1.textContent = p;
    payerSelect.appendChild(option1);
    const option2 = document.createElement('option');
    option2.value = p; option2.textContent = p;
    forWhomSelect.appendChild(option2);
  });
  const allOption = document.createElement('option');
  allOption.value = 'ALL';
  allOption.textContent = 'å…¨å“¡åˆ†';
  forWhomSelect.insertBefore(allOption, forWhomSelect.firstChild);
}

// å‚åŠ è€…ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãï¼‰
function updatePersonList() {
  const list = document.getElementById('personList');
  list.innerHTML = '';
  persons.forEach(p => {
    const li = document.createElement('li');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = p;
    li.appendChild(checkbox);
    li.appendChild(document.createTextNode(' ' + p));
    list.appendChild(li);
  });
}

// æ”¯æ‰•ã„è¡¨ç¤ºï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãï¼‰
function renderPayments() {
  const tbody = document.querySelector('#paymentTable tbody');
  tbody.innerHTML = '';
  payments.forEach((p, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" data-index="${index}"></td>
      <td>${p.payer}</td>
      <td>${p.amount}</td>
      <td>${p.forWhom.join(', ')}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜
function saveData() {
  localStorage.setItem('persons', JSON.stringify(persons));
  localStorage.setItem('payments', JSON.stringify(payments));
}

// åˆæœŸåŒ–
function initialize() {
  if(confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")){
    localStorage.removeItem('persons');
    localStorage.removeItem('payments');
    persons = [];
    payments = [];
    updatePersonSelect();
    updatePersonList();
    renderPayments();
    document.getElementById('result').innerHTML = '';
  }
}

// å‚åŠ è€…è¿½åŠ 
function addPerson() {
  const name = document.getElementById('personName').value.trim();
  if(name && !persons.includes(name)){
    persons.push(name);
    saveData();
    updatePersonSelect();
    updatePersonList();
    document.getElementById('personName').value = '';
  }
}

// é¸æŠå‚åŠ è€…å‰Šé™¤
function deleteSelectedPersons() {
  const checkboxes = document.querySelectorAll('#personList input[type="checkbox"]:checked');
  if(checkboxes.length === 0) return;
  if(!confirm("é¸æŠã—ãŸå‚åŠ è€…ã¨ãã®æ”¯æ‰•ã„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  const selectedNames = Array.from(checkboxes).map(cb => cb.value);
  persons = persons.filter(p => !selectedNames.includes(p));
  payments = payments.filter(pay => !pay.forWhom.some(f => selectedNames.includes(f)) && !selectedNames.includes(pay.payer));
  saveData();
  updatePersonSelect();
  updatePersonList();
  renderPayments();
  document.getElementById('result').innerHTML = '';
}

// æ”¯æ‰•ã„è¿½åŠ 
function addPayment() {
  const payer = document.getElementById('payer').value;
  const amount = parseFloat(document.getElementById('amount').value);
  const forWhomOptions = document.getElementById('forWhom').selectedOptions;
  let forWhom = Array.from(forWhomOptions).map(o => o.value);
  if (forWhom.includes('ALL')) forWhom = [...persons];
  if(!payer || !amount || forWhom.length === 0) return;
  payments.push({payer, amount, forWhom});
  saveData();
  renderPayments();
  document.getElementById('amount').value = '';
}

// é¸æŠæ”¯æ‰•ã„å‰Šé™¤
function deleteSelectedPayments() {
  const checkboxes = document.querySelectorAll('#paymentTable tbody input[type="checkbox"]:checked');
  if(checkboxes.length === 0) return;
  if(!confirm("é¸æŠã—ãŸæ”¯æ‰•ã„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  const indexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
  payments = payments.filter((_, i) => !indexes.includes(i));
  saveData();
  renderPayments();
  document.getElementById('result').innerHTML = '';
}

// ç²¾ç®—è¨ˆç®—
function calculate() {
  const balances = {};
  persons.forEach(p => balances[p] = 0);
  payments.forEach(p => {
    const share = p.amount / p.forWhom.length;
    p.forWhom.forEach(person => {
      if(person !== p.payer) balances[person] -= share;
    });
    balances[p.payer] += share * (p.forWhom.includes(p.payer) ? p.forWhom.length - 1 : p.forWhom.length);
  });

  const owes = Object.entries(balances)
    .filter(([_, v]) => v < 0)
    .map(([name, amt]) => ({ name, amt: -amt }));
  const receives = Object.entries(balances)
    .filter(([_, v]) => v > 0)
    .map(([name, amt]) => ({ name, amt }));

  const result = [];
  let i = 0, j = 0;
  while(i < owes.length && j < receives.length){
    const pay = Math.min(owes[i].amt, receives[j].amt);
    result.push(`${owes[i].name} â†’ ${receives[j].name}: ${pay.toFixed(0)}å††`);
    owes[i].amt -= pay;
    receives[j].amt -= pay;
    if(owes[i].amt === 0) i++;
    if(receives[j].amt === 0) j++;
  }

  const ul = document.getElementById('result');
  ul.innerHTML = '';
  result.forEach(r => { 
    const li = document.createElement('li'); 
    li.textContent = r; 
    ul.appendChild(li); 
  });
}

// åˆæœŸæç”»
updatePersonSelect();
updatePersonList();
renderPayments();
</script>
</body>
</html>